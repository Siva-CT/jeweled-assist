PROJECT DOCUMENTATION & IMPLEMENTATION STEPS
===========================================

PROJECT OVERVIEW
-----------------
"JeweledAssist" is a hybrid B2B/B2C jewelry management system. It combines an automated AI WhatsApp bot for customer interactions with a robust Dashboard for owner control.

TECHNOLOGY STACK
-----------------
1. Runtime: Node.js (Backend)
2. Frontend: React + Vite (Dashboard)
3. Database: In-Memory JSON (db.js) - *Chosen for speed and simplicity*
4. Pricing Engine: Python (yfinance) + Fallback Logic
5. Communication: Twilio API (WhatsApp)

--------------------------------------------------------------------------------

DETAILED CODE IMPLEMENTATION BY COMPONENT
==========================================

PART 1: SERVER (BACKEND)
-------------------------

1. Core Server (`server/index.js`)
   - Setup Express server with CORS to allow communication with the React frontend.
   - Configured Dynamic CORS to support both Localhost and Render deployment (`process.env.FRONTEND_URL`).
   - Added bridge routes to test pricing logic.

2. WhatsApp Bot Logic (`server/routes/whatsapp.js`)
   - **State Machine**: Implemented a session-based state machine (steps: `welcome` -> `buy_category` -> `ask_karat` -> `estimate_weight`...).
   - **Karat Flow**: Added logic to interrupt "Gold" buy requests to specifically ask for Purity (22K vs 24K).
   - **Smart Thresholds**: 
     - If Estimate < Threshold (e.g. ₹20k): Bot auto-calculates and gives price.
     - If Estimate > Threshold: Bot says "Checking with owner" and adds to Approval Queue.
   - **Owner Admin System**:
     - Logic to recognize the Owner by phone number (flexible matching).
     - **Commands**: Implemented text commands for the owner:
       - `Approve 25000`: Approves the last request.
       - `Set Threshold 50000`: Updates settings dynamically.
       - `Reply <msg>`: Talk as the bot.

3. Dashboard API (`server/routes/dashboard.js`)
   - **Syncing**: Created endpoints (`/approve`, `/nudge`) that trigger WhatsApp messages to the customer AND mirror confirmation to the Owner.
   - **Analytics**: Aggregated customer interactions to show "Total Queries" even for non-buyers.
   - **Settings**: Endpoint to read/write global settings (Thresholds, Manual Rates).

4. Pricing Engine (`server/utils/pricingEngine.js` & `fetch_rates.py`)
   - **Python Script**: Fetches live Gold/Silver rates using `yfinance` library.
   - **Node.js Wrapper**: Spawns the Python process and parses JSON output.
   - **Fallback Logic**: If API fails or Market is closed, falls back to:
     - 1. Manual User-Set Rate (High Priority)
     - 2. Realistic Hardcoded Default (e.g., ₹15,596) (Low Priority Fallback)

5. Database (`server/db.js`)
   - Centralized in-memory storage for `sessions`, `messages`, `pendingApprovals` and `settings`.

--------------------------------------------------------------------------------

PART 2: CLIENT (FRONTEND)
-------------------------

1. Dynamic Configuration (`client/src/config.js`)
   - Standardized API calls to use `VITE_API_URL` for seamless switching between Local Dev and Production.

2. Chat Interface (`client/src/components/ChatArea.jsx`)
   - **Real-time Sync**: Polls backend every 3 seconds for new messages.
   - **Bot Control**: Added "Red/Green" toggle button to manually stop/start the bot for a specific user.
   - **Approval UI**: Added "Approve" button for pending estimates that opens a Price input field.

3. Settings Page (`client/src/components/SettingsPage.jsx`)
   - Created UI to manage:
     - Owner Phone Number (Changes Admin instantly).
     - Store Location (Sent to customers asking "Location").
     - Approval Threshold (slider/input).
     - Manual Rate Overrides.

4. Global State (`client/src/App.jsx`)
   - Manages routing between Dashboard, Inbox, Customers, and Settings views.
   - Fetches and aggregates "All Customers" for the directory view.

--------------------------------------------------------------------------------

PART 3: DEPLOYMENT PREPARATION
------------------------------

1. Security Audit
   - Removed all hardcoded Twilio keys.
   - Created `.env.example` to document required variables.
   - Created `.gitignore` to keep the repo clean.

2. Standardization
   - Added `server/requirements.txt` for Python dependencies.
   - Updated `client/src/App.jsx` and components to use environment variables for API paths.

--------------------------------------------------------------------------------

FINAL WORKFLOW SUMMARY
======================
1. Customer asks for Gold Price -> Bot Checks Live Rate.
2. If Price > ₹20k -> Bot asks Owner for Approval.
3. Owner gets WhatsApp alert -> Replies "Approve 22000".
4. Customer gets "Approved" message -> Visits Store.
5. All data logged to Dashboard for analytics.

